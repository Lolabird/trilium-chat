window.__triliumChatVersion="0.1.0",(()=>{"use strict";var t={175:(t,e,n)=>{n.d(e,{Z:()=>o});var s=n(81),i=n.n(s),a=n(645),r=n.n(a)()(i());r.push([t.id,".chat-wrapper .chat_modal {\n  position: fixed;\n  z-index: 1000;\n  display: none;\n  inset: 0;\n}\n.chat-wrapper .chat_modal.show {\n  display: block;\n}\n.chat-wrapper .chat_modal .modal_mask {\n  position: absolute;\n  z-index: -1;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  left: 0;\n  pointer-events: auto;\n  transition: all 0.3s;\n}\n.chat-wrapper .chat_modal .modal_mask.fadein {\n  background: rgba(0, 0, 0, 0.45);\n}\n.chat-wrapper .chat_modal .content_wrapper {\n  position: absolute;\n  z-index: 1000;\n  background: var(--main-background-color);\n  transition: all 0.3s;\n  will-change: transform, opacity;\n}\n.chat-wrapper .chat_modal .content_wrapper_popup {\n  bottom: 0;\n  width: 100%;\n  height: 70%;\n  border-radius: 8px 8px 0 0;\n  transform: translateY(100%);\n}\n.chat-wrapper .chat_modal .content_wrapper_popup.fadein {\n  transform: translateY(0);\n}\n.chat-wrapper .chat_modal .content_wrapper_dialog {\n  width: calc(100% - 40px);\n  border-radius: 8px;\n  opacity: 0;\n  transform: scale(0.1);\n}\n.chat-wrapper .chat_modal .content_wrapper_dialog.fadein {\n  top: 30% !important;\n  left: 20px !important;\n  opacity: 1;\n  transform: scale(1);\n}\n.chat-wrapper .chat_popover {\n  position: absolute;\n  opacity: 0;\n  will-change: transform, opacity, top, left, right, top;\n}\n.chat-wrapper .chat_popover .tooltip-text {\n  padding: 6px;\n  border: 1px solid var(--main-border-color);\n  background: var(--main-background-color);\n  border-radius: 4px;\n}\n.chat-wrapper .chat_popover.fadein {\n  opacity: 1;\n  transform: scale(1) !important;\n}\n.chat-wrapper .form_wrapper {\n  padding: 10px 16px;\n}\n.chat-wrapper .form_wrapper .wapper_title {\n  font-size: 120%;\n}\n.chat-wrapper .form_wrapper .wrapper_op {\n  margin-top: 3px;\n  text-align: right;\n}\n.chat-wrapper .form_wrapper .chat_button {\n  display: inline-block;\n  width: 70px;\n  border-color: var(--main-text-color);\n}\n.chat-wrapper .form_wrapper .wrapper_btn_save {\n  border: none;\n  background: var(--trilium-green);\n  color: var(--main-background-color);\n}\n.chat-wrapper .form_wrapper .wrapper_btn_save:hover {\n  opacity: 0.8;\n}\n.chat-wrapper .form_wrapper .wrapper_btn_cancel {\n  border: 1px solid var(--main-border-color);\n  color: var(--main-border-color);\n}\n.chat-wrapper .form_wrapper .wrapper_btn_cancel:hover {\n  border: 1px solid var(--trilium-green);\n  color: var(--trilium-green);\n}\n.chat-wrapper .thread {\n  display: flex;\n  flex: 1;\n  flex-direction: column;\n  padding: 10px;\n  padding-bottom: 50px;\n  border-bottom: 1px solid var(--main-border-color);\n  background: var(--left-pane-background-color);\n  overflow-y: auto;\n  scroll-behavior: smooth;\n}\n.chat-wrapper .thread .message {\n  display: flex;\n  max-width: 80%;\n  flex-direction: column;\n  padding: 8px 10px;\n  margin-bottom: 10px;\n}\n.chat-wrapper .thread .received {\n  align-self: flex-start;\n  background-color: var(--main-background-color);\n  border-radius: 2px 12px 12px;\n}\n.chat-wrapper .thread .sent {\n  align-self: flex-end;\n  background-color: var(--trilium-green);\n  border-radius: 12px 2px 12px 12px;\n  color: #fff;\n}\n.chat-wrapper .operate {\n  display: flex;\n  height: 210px;\n  flex-direction: column;\n  padding: 0 16px;\n}\n.chat-wrapper .operate .operate_top {\n  height: 44px;\n}\n.chat-wrapper .operate .operate_top .operate_btn {\n  margin-right: 2px;\n  color: #666;\n}\n.chat-wrapper .operate .operate_top .operate_btn_new:hover {\n  border-color: var(--trilium-green);\n  color: var(--trilium-green) !important;\n}\n.chat-wrapper .operate .operate_input {\n  position: relative;\n  flex: 1;\n}\n.chat-wrapper .operate .operate_input .input-area {\n  width: 100%;\n  height: 100%;\n  padding: 6px 8px;\n  border: none;\n  border: 1px solid var(--main-border-color);\n  background-color: var(--main-background-color) !important;\n  border-radius: 8px;\n  outline: none;\n  resize: none;\n  transition: border 0.2s;\n  /*  &::placeholder {\n                color: #ddd;\n            } */\n}\n.chat-wrapper .operate .operate_input .input-area:focus {\n  border: 1px solid var(--trilium-green);\n}\n.chat-wrapper .operate .operate_input .operate_send {\n  position: absolute;\n  right: 6px;\n  bottom: 6px;\n  color: var(--trilium-green);\n}\n.chat-wrapper .operate .operate_input .operate_send.freezed {\n  color: var(--main-border-color);\n}\n.chat-wrapper .operate .operate_bottom {\n  height: 36px;\n}\n.chat-wrapper .operate .operate_bottom .thread_op {\n  display: none;\n  border: 1px solid var(--main-border-color);\n  background: var(--main-background-color);\n  border-radius: 8px;\n}\n.chat-wrapper .operate .operate_bottom .thread_op.show {\n  display: block;\n}\n.chat-wrapper .content_select {\n  display: flex;\n  height: 100%;\n  flex-direction: column;\n  user-select: none;\n}\n.chat-wrapper .content_select .select_top {\n  height: 44px;\n  padding-right: 4px;\n  padding-left: 16px;\n  border-bottom: 1px solid var(--main-border-color);\n}\n.chat-wrapper .content_select .select_search {\n  height: 40px;\n  padding: 0 10px;\n  border: 1px solid var(--main-border-color);\n  margin: 10px 16px;\n  border-radius: 8px;\n}\n.chat-wrapper .content_select .bx-search {\n  font-size: 120%;\n}\n.chat-wrapper .content_select .select_search_input {\n  flex: 1;\n  margin-left: 4px;\n}\n.chat-wrapper .content_select .select_list {\n  flex: 1;\n  padding: 0 16px;\n  overflow-y: auto;\n}\n.chat-wrapper .content_select .select_item {\n  position: relative;\n  padding: 8px;\n  border-radius: 8px;\n  color: var(--inactive-tab-text-color);\n  cursor: pointer;\n  font-size: 90%;\n}\n.chat-wrapper .content_select .select_item::after {\n  position: absolute;\n  bottom: 0;\n  width: calc(100% - 16px);\n  border-bottom: 1px solid var(--left-pane-background-color);\n  content: '';\n}\n.chat-wrapper .content_select .select_item:hover {\n  background: var(--left-pane-background-color);\n}\n.chat-wrapper .content_select .select_item .item_title {\n  color: var(--main-text-color);\n  font-weight: 700;\n}\n.chat-wrapper .content_select .select_item .item_stamp {\n  font-size: 80%;\n}\n.chat-wrapper .popover_prompt {\n  width: 100%;\n  height: 300px;\n  min-height: 300px;\n  background: var(--main-background-color);\n  box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);\n}\n.chat-wrapper .content_select_prompt .item_up {\n  position: relative;\n}\n.chat-wrapper .content_select_prompt .item_title {\n  padding-right: 60px;\n}\n.chat-wrapper .content_select_prompt .item_op {\n  position: absolute;\n  top: 0;\n  right: 0;\n  display: none;\n}\n.chat-wrapper .content_select_prompt .item_op .icon-action {\n  width: 24px;\n  height: 24px;\n  padding: 0;\n}\n.chat-wrapper .content_select_prompt .select_item:hover .item_op {\n  display: block;\n}\n.chat-wrapper {\n  position: fixed;\n  z-index: 1000;\n  top: 40px;\n  right: 0;\n  display: flex;\n  overflow: hidden;\n  width: 420px;\n  min-width: 420px;\n  max-width: calc(100% - 40px);\n  height: calc(100% - 40px);\n  flex-direction: column;\n  border: 1px solid var(--main-border-color);\n  border-right: none;\n  border-bottom: none;\n  background: var(--main-background-color);\n  border-radius: 8px 0 0 8px;\n  box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1);\n  transform: translate3d(120%, 0, 0);\n  transition: transform 0.3s;\n  visibility: visible !important;\n  will-change: width;\n  --trilium-green: #50a52c;\n}\n.chat-wrapper *::-webkit-scrollbar {\n  width: 6px;\n}\n.chat-wrapper input {\n  border: none;\n  outline: none;\n}\n.chat-wrapper * {\n  box-sizing: border-box;\n}\n.chat-wrapper.show {\n  transform: translateZ(0);\n}\n.chat-wrapper .flex-center {\n  display: flex;\n  align-items: center;\n}\n.chat-wrapper .flex-center-between {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n}\n.chat-wrapper .flex-row-reverse {\n  display: flex;\n  flex-direction: row-reverse;\n  align-items: center;\n}\n.chat-wrapper .no-shrink {\n  flex-shrink: 0;\n}\n.chat-wrapper .one-line {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n.chat-wrapper .link,\n.chat-wrapper .link:visited,\n.chat-wrapper .link:hover {\n  color: inherit;\n  text-decoration: none;\n}\n.chat-wrapper .icon-view {\n  font-size: 180%;\n}\n.chat-wrapper .icon-action {\n  width: 36px;\n  height: 36px;\n}\n.chat-wrapper .chat_button {\n  padding: 5px 8px;\n  border: 1px solid var(--button-border-color);\n  background: var(--button-background-color);\n  border-radius: 8px;\n  color: var(--main-text-color);\n  cursor: pointer;\n  text-align: center;\n  transition: all 0.2s;\n  user-select: none;\n}\n.chat-wrapper .chat_button:hover {\n  text-decoration: none;\n}\n.chat-wrapper .chat_button:disabled {\n  cursor: not-allowed;\n}\n.chat-wrapper .resizer {\n  position: absolute;\n  z-index: 1;\n  top: 0;\n  bottom: 0;\n  left: 0;\n  width: 8px;\n  cursor: e-resize;\n  user-select: none;\n}\n.chat-wrapper .header {\n  display: flex;\n  height: 37px;\n  align-items: center;\n  justify-content: space-between;\n  padding-left: 10px;\n  border-bottom: 1px solid var(--main-border-color);\n}\n.chat-wrapper .header .header_hide {\n  border-radius: 0;\n}\n.chat-wrapper .header .header_hide:hover {\n  border: 1px solid transparent;\n  background: var(--left-pane-background-color);\n}\n.chat-wrapper .prompt_content {\n  overflow: hidden;\n  height: 0;\n  flex-shrink: 0;\n  background: var(--main-background-color);\n  transition: height 0.3s;\n}\n.chat-wrapper .prompt_content.show {\n  max-height: 200px;\n  border-bottom: 1px solid var(--main-border-color);\n}\n.chat-wrapper .prompt_content .prompt_content_close {\n  height: 40px;\n  padding-right: 4px;\n  border-bottom: 1px solid var(--main-border-color);\n}\n.chat-wrapper .prompt_content .prompt_content_text {\n  max-height: 160px;\n  padding: 10px;\n  overflow-y: auto;\n}\n.chat-wrapper .content_command {\n  background: var(--main-background-color);\n  border-radius: 8px;\n  box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);\n  user-select: none;\n}\n.chat-wrapper .content_command .command_title {\n  padding-left: 10px;\n  border-bottom: 1px solid var(--main-border-color);\n  line-height: 36px;\n}\n.chat-wrapper .content_command .command_item {\n  padding: 4px 10px;\n  cursor: pointer;\n}\n.chat-wrapper .content_command .command_item:hover {\n  background: var(--left-pane-background-color);\n}\n.chat-wrapper .content_prompt_form label {\n  display: block;\n}\n.chat-wrapper .content_prompt_form .prompt_input {\n  width: 100%;\n  padding-left: 8px;\n  border: 1px solid var(--main-border-color);\n  border-radius: 8px;\n  line-height: 30px;\n  transition: all 0.3s;\n}\n.chat-wrapper .content_prompt_form .prompt_input:focus {\n  border-color: var(--trilium-green);\n}\n.chat-wrapper .content_prompt_form .prompt_input_content {\n  min-height: 170px;\n  outline: none;\n  resize: none;\n}\n",""]);const o=r},447:(t,e,n)=>{n.d(e,{Z:()=>o});var s=n(81),i=n.n(s),a=n(645),r=n.n(a)()(i());r.push([t.id,".chat-toggle-wrapper {\n  display: flex;\n  height: 100%;\n}\n.chat-toggle-wrapper .button-widget {\n  font-size: 1.5em !important;\n  line-height: 1 !important;\n}\n",""]);const o=r},645:t=>{t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var n="",s=void 0!==e[5];return e[4]&&(n+="@supports (".concat(e[4],") {")),e[2]&&(n+="@media ".concat(e[2]," {")),s&&(n+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),n+=t(e),s&&(n+="}"),e[2]&&(n+="}"),e[4]&&(n+="}"),n})).join("")},e.i=function(t,n,s,i,a){"string"==typeof t&&(t=[[null,t,void 0]]);var r={};if(s)for(var o=0;o<this.length;o++){var h=this[o][0];null!=h&&(r[h]=!0)}for(var c=0;c<t.length;c++){var l=[].concat(t[c]);s&&r[l[0]]||(void 0!==a&&(void 0===l[5]||(l[1]="@layer".concat(l[5].length>0?" ".concat(l[5]):""," {").concat(l[1],"}")),l[5]=a),n&&(l[2]?(l[1]="@media ".concat(l[2]," {").concat(l[1],"}"),l[2]=n):l[2]=n),i&&(l[4]?(l[1]="@supports (".concat(l[4],") {").concat(l[1],"}"),l[4]=i):l[4]="".concat(i)),e.push(l))}},e}},81:t=>{t.exports=function(t){return t[1]}},379:t=>{var e=[];function n(t){for(var n=-1,s=0;s<e.length;s++)if(e[s].identifier===t){n=s;break}return n}function s(t,s){for(var a={},r=[],o=0;o<t.length;o++){var h=t[o],c=s.base?h[0]+s.base:h[0],l=a[c]||0,p="".concat(c," ").concat(l);a[c]=l+1;var d=n(p),u={css:h[1],media:h[2],sourceMap:h[3],supports:h[4],layer:h[5]};if(-1!==d)e[d].references++,e[d].updater(u);else{var m=i(u,s);s.byIndex=o,e.splice(o,0,{identifier:p,updater:m,references:1})}r.push(p)}return r}function i(t,e){var n=e.domAPI(e);return n.update(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap&&e.supports===t.supports&&e.layer===t.layer)return;n.update(t=e)}else n.remove()}}t.exports=function(t,i){var a=s(t=t||[],i=i||{});return function(t){t=t||[];for(var r=0;r<a.length;r++){var o=n(a[r]);e[o].references--}for(var h=s(t,i),c=0;c<a.length;c++){var l=n(a[c]);0===e[l].references&&(e[l].updater(),e.splice(l,1))}a=h}}},569:t=>{var e={};t.exports=function(t,n){var s=function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(t){n=null}e[t]=n}return e[t]}(t);if(!s)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");s.appendChild(n)}},216:t=>{t.exports=function(t){var e=document.createElement("style");return t.setAttributes(e,t.attributes),t.insert(e,t.options),e}},565:(t,e,n)=>{t.exports=function(t){var e=n.nc;e&&t.setAttribute("nonce",e)}},795:t=>{t.exports=function(t){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var e=t.insertStyleElement(t);return{update:function(n){!function(t,e,n){var s="";n.supports&&(s+="@supports (".concat(n.supports,") {")),n.media&&(s+="@media ".concat(n.media," {"));var i=void 0!==n.layer;i&&(s+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),s+=n.css,i&&(s+="}"),n.media&&(s+="}"),n.supports&&(s+="}");var a=n.sourceMap;a&&"undefined"!=typeof btoa&&(s+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),e.styleTagTransform(s,t,e.options)}(e,t,n)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(e)}}}},589:t=>{t.exports=function(t,e){if(e.styleSheet)e.styleSheet.cssText=t;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}}}},e={};function n(s){var i=e[s];if(void 0!==i)return i.exports;var a=e[s]={id:s,exports:{}};return t[s](a,a.exports,n),a.exports}n.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},n.d=(t,e)=>{for(var s in e)n.o(e,s)&&!n.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.nc=void 0,(()=>{const t="user",e="assistant",s="error",i="viewShow",a="viewHide",r="formSave",o="formCancel",h="promptToggle",c="create",l="append",p="replace",d="setStatus",u="load",m="setStatus",g="success",w={none:"none",fetching:"fetching",generating:"generating",success:"success",faild:"faild",cancel:"cancel"},f="show",v="viewWidth",$="CHAT_OPTIONS",b="CHAT_PROMPTS",y="CHAT_HISTORY_HOME",x={viewWidth:400,engine:"chatGpt",apiKey:"",engineOptions:{model:"gpt-3.5-turbo",max_tokens:2500,temperature:.3,top_p:1,presence_penalty:.5,frequency_penalty:.5,stream:!0,n:1},shortcut:{toggle:"Alt+Q",hide:"Esc"},faces:["bx-smile","bx-wink-smile","bx-face","bx-happy-alt","bx-cool","bx-laugh","bx-upside-down"],colors:["var(--muted-text-color)"],autoSave:!0},_=[{id:"official-0",name:"translate",content:"Translate the following content to {{language:English|Chinese|Franch}} language: \n {{message}}",order:0},{id:"official-1",name:"translateNote",content:"Translate the following content to {{language:English|Chinese|Franch}} language: \n {{activeNote}}",order:1}];class E{constructor(){this.listeners={}}addEventListener(t,e){this.listeners[t]||(this.listeners[t]=[]),-1===this.listeners[t].indexOf(e)&&this.listeners[t].push(e)}on(t,e){return this.addEventListener(t,e)}removeEventListener(t,e){if(!this.listeners[t])return;const n=[];for(let s=0;s<this.listeners[t].length;s+=1)this.listeners[t][s]!==e&&n.push(this.listeners[t][s]);0===this.listeners[t].length?delete this.listeners[t]:this.listeners[t]=n}off(t,e){return this.removeEventListener(t,e)}dispatchEvent(t){if(!t)return!0;t.source=this;const e=`on${t.type}`;return(!Object.hasOwnProperty.call(this,e)||(this[e].call(this,t),!t.defaultPrevented))&&(!this.listeners[t.type]||this.listeners[t.type].every((e=>(e(t),!t.defaultPrevented))))}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach((t=>{t(...e)}))}}class S extends E{constructor(t,e={}){super(),this.url=t,this.method=e.method||"GET",this.headers=e.headers||{},this.payload=e.payload||null,this.withCredentials=e.withCredentials||!1,this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2}_setReadyState(t){const e=new CustomEvent("readyStateChange");e.readyState=t,this.readyState=t,this.dispatchEvent(e)}_onStreamFailure(t){const e=new CustomEvent("error");e.data=t.currentTarget.response,this.dispatchEvent(e),this.close()}_onStreamAbort(){this.close()}_onStreamProgress(t){if(!this.xhr)return;if(200!==this.xhr.status)return void this._onStreamFailure(t);this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this._setReadyState(this.OPEN));const e=this.xhr.responseText.substring(this.progress);this.progress+=e.length,e.split(/(\r\n|\r|\n){2}/g).forEach((t=>{0===t.trim().length?(this.dispatchEvent(this._parseEventChunk(this.chunk.trim())),this.chunk=""):this.chunk+=t}))}_onStreamLoaded(t){this._onStreamProgress(t),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk=""}_parseEventChunk(t){if(!t||0===t.length)return null;const e={id:null,retry:null,data:"",event:"message"};t.split(/(\r\n|\r|\n)/).forEach((t=>{const n=t.trimRight(),s=n.indexOf(this.FIELD_SEPARATOR);if(s<=0)return;const i=n.substring(0,s);if(!(i in e))return;const a=n.substring(s+1).trimLeft();"data"===i?e[i]+=a:e[i]=a}));const n=new CustomEvent(e.event);return n.data=e.data,n.id=e.id,n}_checkStreamClosed(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this._setReadyState(this.CLOSED)}stream(){this._setReadyState(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url),Object.keys(this.headers).forEach((t=>{this.xhr.setRequestHeader(t,this.headers[t])})),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}close(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this._setReadyState(this.CLOSED))}}const C="...";class k extends E{constructor({apiKey:t,engineOptions:e}){super(),this.urls={completion:"https://api.openai.com/v1/chat/completions"},this.apiKey=t,this.defaultOptions=e}get lastMessage(){return this.thread.length?this.thread[this.thread.length-1]:null}set lastMessage(t){if(!this.thread[this.thread.length-1])throw new Error("lastMessage not exist");this.thread[this.thread.length-1]=t}newChat(t){const e=[];t&&e.push({role:"system",content:t,status:w.success}),this.loadThread({id:Date.now().toString(),list:e}),this.emit(d,w.none)}loadThread(t){this.endStream(),this.threadId=t.id,this.thread=t.list.map((t=>({...t,status:w.success}))),this.emit(u,this.thread)}isEngineAvailable(){return!this.lastMessage||[w.success,w.cancel].includes(this.lastMessage.status)}setLastMessageStatus(t){this.lastMessage.status!==t&&(this.lastMessage.status=t,t===w.success&&(this.lastMessage.stamp=Date.now()),this.emit(d,t))}createMessage(e,n=t){const s={role:n,content:e};this.thread.push(s);const i=n===t?w.success:w.fetching;this.setLastMessageStatus(i),this.emit(c,{...this.lastMessage})}replaceMessage(t,e,n){if(!t)throw new Error("content required");this.lastMessage.content=t,this.lastMessage.role=n||this.lastMessage.role,this.setLastMessageStatus(e||this.lastMessage.status),this.emit(p,{...this.lastMessage})}appendMessageWords(t){this.lastMessage&&(this.lastMessage.content+=t,this.emit(l,{word:t,...this.lastMessage}))}requestCompletion({userInput:t,overrideOptions:n={}}){const s="string"==typeof t&&""===t.trim();if(t&&!s)return this.createMessage(t),this.createMessage(C,e),this.sendRequest(n)}async sendRequest(t={}){const e={messages:this.thread.reduce(((t,e)=>(e.status!==w.success&&e.status!==w.cancel||t.push({role:e.role,content:e.content}),t)),[]),...this.defaultOptions,...t};if(this.apiKey)try{e.stream?await this.requestChatStream(e):await this.requestChatBatch(e)}catch(t){console.error(t),this.replaceMessage("API Error. See console logs for details.",w.faild,s)}else this.replaceMessage("please config your apikey in options file",w.faild,s)}regenerate(n){if(this.lastMessage.role===t)throw new Error("error detected!");this.replaceMessage(C,w.fetching,e),this.sendRequest(n)}async requestChatStream(t){await new Promise(((n,s)=>{try{this.activeStream=new S(this.urls.completion,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},method:"POST",payload:JSON.stringify(t)});let i="";this.activeStream.addEventListener("message",(t=>{if("[DONE]"!==t.data){const e=JSON.parse(t.data).choices[0].delta.content;if(!e)return;i+=e,this.lastMessage.content===C?this.replaceMessage(e,w.generating):this.appendMessageWords(e)}else this.endStream(),this.setLastMessageStatus(w.success),n(i)})),this.activeStream.addEventListener("readystatechange",(t=>{t.readyState>=2&&console.log(`ReadyState: ${t.readyState}`)})),this.activeStream.addEventListener("error",(t=>{this.endStream(),s(t)})),this.emit("beforeStream",{role:e}),this.activeStream.stream()}catch(t){this.endStream(),s(t)}}))}cencelGenerating(){this.setLastMessageStatus(w.cancel),this.emit("cancel",{...this.lastMessage}),this.endStream()}endStream(){this.activeStream&&(this.activeStream.close(),this.activeStream=null)}async requestChatBatch(t){const e=await this.requestCompletionBatch(t);this.replaceMessage(e,w.success)}async requestCompletionBatch(t){const e=await fetch(this.urls.completion,{method:"POST",mode:"cors",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(t)}),{content:n}=(await e.json()).choices[0].message;return n}}var L=n(379),M=n.n(L),T=n(795),V=n.n(T),q=n(569),O=n.n(q),P=n(565),B=n.n(P),I=n(216),D=n.n(I),A=n(589),N=n.n(A),R=n(175),F={};F.styleTagTransform=N(),F.setAttributes=B(),F.insert=O().bind(null,"head"),F.domAPI=V(),F.insertStyleElement=D(),M()(R.Z,F),R.Z&&R.Z.locals&&R.Z.locals;const H={};function z(t){if(!t)throw new Error("should implement in child classes")}function j(t,e){throw new Error(JSON.stringify({type:t,reason:e}))}function W(t,e,n){"boolean"==typeof e?e?t.classList.add(n):t.classList.remove(n):t.classList.contains(n)?t.classList.remove(n):t.classList.add(n)}function J(t,e){W(t,e,f)}function G(t,e){W(t,e,"fadein")}async function Z(t){await new Promise((e=>{setTimeout(e,t)}))}function U(t){if(t.parentElement)return t.parentElement.removeChild(t)}async function K(){await Z(10)}function Y(t,e){return e?.matches?e.matches(t)?e:Y(t,e.parentNode):null}const X=/{{([^}]+):([^}]+)}}/g;class Q{constructor(t){this.chatView=t,this.$thread=t.$chatView.$qs(".thread"),this.isHovering=!1,this.wrapFunction(),this.bindThreadHover(),this.bindEngineEvents()}wrapFunction(){this.scrolToBottom=function(t,e){let n=0;return function(...e){const s=(new Date).getTime();s-n>=300&&(t.apply(this,e),n=s)}}(this.scrolToBottom)}bindThreadHover(){this.$thread.addEventListener("mouseenter",(()=>{this.isHovering=!0})),this.$thread.addEventListener("mouseleave",(()=>{this.isHovering=!1}))}bindEngineEvents(){const{chatEngine:t}=this.chatView;t.on(u,(t=>{this.renderThread(t)})),t.on(c,(t=>{this.appendElByMessage(t)})),t.on(l,(t=>{this.replaceCurrentElContent(t.content)})),t.on(p,(t=>{this.replaceCurrentElContent(t.content)}))}renderThread(t){this.$thread.innerHTML="",t.forEach((t=>{this.appendElByMessage(t)}))}appendElByMessage(t){const e=document.createElement("div");e.classList.add("message"),e.classList.add("user"===t.role?"sent":"received");const n=document.createElement("div");return n.textContent=t.content,e.appendChild(n),this.$thread.appendChild(e),this.scrolToBottom(),e}scrolToBottom(){window.requestIdleCallback((()=>{this.$thread.scrollTop=1e11}))}getCurrentMsgDom(){const{children:t}=this.$thread;return t[t.length-1]}replaceCurrentElContent(t){this.getCurrentMsgDom().children[0].textContent=t,this.isHovering||this.scrolToBottom()}removeCurrentEl(){U(this.getCurrentMsgDom())}}class tt extends E{constructor(t){super(),this.view=t,this.$chatView=t.$chatView,this.$resizer=this.$chatView.$qs(".resizer"),this.bindResize()}bindResize(){let t=-1,e=-1,n=-1;const s=s=>{s.stopPropagation(),function(t,e="default"){!H[e]&&(H[e]=!0,window.requestAnimationFrame((n=>{H[e]=!1,t(n)})))}((()=>{n=e+(t-s.x),this.$chatView.style.width=`${n}px`}),"handleMousemove")},i=t=>{t.stopPropagation(),document.body.style.cursor=null,this.view.chatData.setOption(v,n),document.removeEventListener("mousemove",s,!0),document.removeEventListener("mouseup",i)};this.$resizer.addEventListener("mousedown",(n=>{n.preventDefault(),n.stopPropagation(),document.body.style.cursor="e-resize",t=n.x,e=Number(window.getComputedStyle(this.$chatView).width.replace("px","")),document.addEventListener("mousemove",s,!0),document.addEventListener("mouseup",i)}),!0)}}class et extends E{constructor(t){super(),this.chatView=t,this.$stop=t.$chatView.$qs(".thread_op_stop"),this.$stop.addEventListener("click",(()=>{t.chatEngine.cencelGenerating()})),this.$regenerate=t.$chatView.$qs(".thread_op_regenerate"),this.$regenerate.addEventListener("click",(()=>{t.chatEngine.regenerate()})),this.bindEngineEvents()}bindEngineEvents(){this.chatView.chatEngine.on(d,(t=>{this.toggleStopGenerating([w.generating,w.fetching].includes(t)),this.toggleRegenerate([w.cancel,w.faild].includes(t))}))}toggleStopGenerating(t){J(this.$stop,t)}toggleRegenerate(t){J(this.$regenerate,t)}}class nt extends E{constructor(t){super(),this.chatView=t,this.$userInput=t.$chatView.$qs(".input-area"),this.$sendBtn=t.$chatView.$qs(".operate_send"),this.engineStatus=w.none,this.bindInput(),this.bindSendMessage(),this.bindEngineEvents(),this.bindPromptStatus(),this.lastSetBtnStyle=this.setBtnStyle()}bindInput(){this.$userInput.addEventListener("input",(()=>{this.setBtnStyle()}))}bindEngineEvents(){this.chatView.chatEngine.on(d,(t=>{this.enableUserInput(t!==w.faild),this.handleMsgStatus(t)}))}bindPromptStatus(){this.chatView.elePrompt.on(h,(()=>{this.setBtnStyle()}))}handleMsgStatus(t){this.engineStatus=t,this.setBtnStyle()}async setBtnStyle(){await this.lastSetBtnStyle;let t="";if([w.none,w.success,w.cancel].includes(this.engineStatus)){if(!await this.getParsedMsg())return this.$sendBtn.classList.add("freezed"),void this.$sendBtn.setAttribute("title","Type a message");this.$sendBtn.classList.remove("freezed"),t="Send(Enter to send, Shift+Enter to break line)"}else this.$sendBtn.classList.add("freezed"),t=this.engineStatus===w.faild?"Regenerating is worth a try":"Wait a moment";this.$sendBtn.setAttribute("title",t)}bindSendMessage(){const t=async()=>{const t=await this.getParsedMsg();t&&this.chatView.chatEngine.isEngineAvailable()&&(this.chatView.chatEngine.requestCompletion({userInput:t}),this.clearInput())};this.$sendBtn.addEventListener("click",t.bind(this)),this.$userInput.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),t.call(this))}))}async getParsedMsg(){const t=this.chatView.elePrompt.$getParsedPromt(),e=this.$userInput.value;if(!t)return e;let n=t;const s=/{{message}}/g,i=/{{activeNote}}/g;if(s.test(n)&&(n=n.replace(s,e)),i.test(n))try{n=n.replace(i,await this.chatView.chatData.getAcitveNoteContent())}catch(t){return console.error(t),null}return n.trim()}enableUserInput(t){this.$userInput.disabled=!t}clearInput(){this.$userInput.value=""}}const st={[w.none]:"",[w.fetching]:"Thinking...",[w.generating]:"Typing...",[w.success]:"success",[w.faild]:w.faild,[w.cancel]:w.cancel};class it{constructor(t){this.chatView=t,this.$status=t.$chatView.$qs(".operate_status"),t.chatEngine.on(d,(t=>{this.handleMsgStatus(t)}))}handleMsgStatus(t){const e=st[t];this.$status.textContent=e}handleDataStatus(t){const{status:e,key:n,value:s}=t;this.$status.textContent=e===g?"":`${e}: ${n} - ${s}`}}class at{constructor(t){this.options=t.options,this.view=t,this.$face=t.$chatView.$qs(".header_face"),t.on(i,(()=>{this.refreshFace()}))}refreshFace(){const t=this.options.faces,e=this.options.colors,n=t[Math.floor(Math.random()*t.length)],s=e[Math.floor(Math.random()*e.length)];this.$face.classList.forEach((t=>{/bx.+/.test(t)&&this.$face.classList.remove(t)})),this.$face.style.color=s,this.$face.classList.add(n)}}class rt{constructor(t){this.chatView=t,this.$collapse=t.$chatView.$qs(".header_hide"),this.bindCollapse()}bindCollapse(){this.$collapse.addEventListener("click",(()=>{this.chatView.hideView()}))}}const ot=new Map;function ht(t,e){return ot.set(t,e),function(){ot.delete(t)}}function ct(t){ot.forEach(((e,n)=>{n.contains(t.target)||e.call(n,t)}))}ht.globalClick=ct,document.addEventListener("click",ct);const lt={global:0,currentModal:null};class pt{constructor({type:t="dialog",$content:e,$chatView:n}){this.type=t,this.wrapperClassName={popup:"content_wrapper_popup",dialog:"content_wrapper_dialog"}[t],this.$content=U(e),this.$chatView=n,this.$modal=null,this.isShow=!1}async show(t){if(!this.isShow){if(this.$modal||this.initModal(),lt.global+=1,this.$modal.style.zIndex=lt.global,lt.currentModal=lt.global,this.$chatView.appendChild(this.$modal),J(this.$modal,!0),this.$contentWrapper.classList.add(this.wrapperClassName),"popup"!==this.type){const{offsetWidth:e,offsetHeight:n}=this.$contentWrapper,{offsetLeft:s,offsetTop:i}=this.$chatView;this.$contentWrapper.style.left=t.x-s-e/2+"px",this.$contentWrapper.style.top=t.y-i-n/2+"px"}await K(),G(this.$mask,!0),G(this.$contentWrapper,!0),this.isShow=!0}}initModal(){const t=document.createElement("template");t.innerHTML='<div class="chat_modal">\n<div class="modal_mask"></div>\n<div class="content_wrapper"></div>\n</div>',this.$modal=t.content.lastChild,this.$mask=this.$modal.$qs(".modal_mask"),this.$contentWrapper=this.$modal.$qs(".content_wrapper"),this.$contentWrapper.appendChild(this.$content),this.bindClick()}bindClick(){this.$mask.addEventListener("click",(t=>{this.hide()})),this.$contentWrapper.addEventListener("click",(t=>{}))}async hide(){if(!this.isShow)return;const t=()=>{J(this.$modal,!1),this.$contentWrapper.classList.remove(this.wrapperClassName),U(this.$modal),this.isShow=!1,lt.currentModal=null,this.$mask.removeEventListener("transitionend",t)};this.$mask.addEventListener("transitionend",t),G(this.$mask,!1),G(this.$contentWrapper,!1)}}class dt extends E{constructor(t){super(),this.view=t,this.$content=t.$chatView.$qs(".content_select_history"),this.Modal=new pt({type:"popup",$content:this.$content,$chatView:t.$chatView}),this.$showBtn=t.$chatView.$qs(".operate_btn_history"),this.$num=this.$content.$qs(".select_num"),this.$closeBtn=this.$content.$qs(".select_close"),this.$search=this.$content.$qs(".select_search_input"),this.$list=this.$content.$qs(".select_list"),this.$recordTpl=U(this.$content.$qs(".select_item")),this.records=[],this.bindEvents(),t.on(a,(()=>{this.hide()}))}hide(){this.Modal.hide()}bindEvents(){this.$showBtn.addEventListener("click",(async t=>{this.Modal.show(t),this.loadHistory()})),this.$closeBtn.addEventListener("click",(()=>{this.hide()})),this.$search.addEventListener("input",(t=>{this.renderSearch(t.target.value)})),this.$list.addEventListener("click",(t=>{const e=Y("[data-id]",t.target);if(e){const t=this.records.find((t=>t.id===e.dataset.id));this.Modal.hide(),this.view.chatEngine.loadThread(t)}}))}async loadHistory(){const t=await this.view.chatData.getRecords();this.records=Object.keys(t).map((e=>({id:e,...t[e]})));const e=[...this.records.filter((t=>t.favor)).sort(this.sortByStamp),...this.records.filter((t=>!t.favor)).sort(this.sortByStamp)];this.renderCount(this.records.length),this.renderList(e)}sortByStamp(t,e){const n=t.list[t.list.length-1];return e.list[e.list.length-1].stamp-n.stamp}renderCount(t){this.$num.textContent=t}renderList(t){this.$list.innerHTML="";const e=document.createDocumentFragment();t.forEach((t=>{const n=t.list[1],s=t.list[t.list.length-1],i=this.$recordTpl.cloneNode(!0);i.setAttribute("data-id",t.id),i.$qs(".item_title").textContent=t.title||t.originTitle,i.$qs(".item_stamp").textContent=function(t){const e=Math.floor((new Date-new Date(t))/1e3);let n=Math.floor(e/31536e3);return n>=1?`${n} year${1===n?"":"s"} ago`:(n=Math.floor(e/2592e3),n>=1?`${n} month${1===n?"":"s"} ago`:(n=Math.floor(e/86400),n>=1?`${n} day${1===n?"":"s"} ago`:(n=Math.floor(e/3600),n>=1?`${n} hour${1===n?"":"s"} ago`:(n=Math.floor(e/60),n>=1?`${n} minute${1===n?"":"s"} ago`:0===e?"just now":`${Math.floor(e)} second${1===Math.floor(e)?"":"s"} ago`))))}(s.stamp);const a=i.$qs(".item_preview");a.setAttribute("title",n.content),a.textContent=n.content,e.appendChild(i)})),this.$list.appendChild(e)}renderSearch(t){const e=this.records.filter((e=>e.list.some((e=>e.content.includes(t)))));this.renderList(e)}}class ut extends E{constructor(t){super(),this.$newBtn=t.$chatView.$qs(".operate_btn_new"),this.$newBtn.addEventListener("click",(()=>{t.chatEngine.newChat()}))}}const mt={};class gt{constructor({useTransition:t=!0,placement:e,offset:n,contentSelector:s,$edgeEle:i,$triggerEle:a,text:r,hideDelay:o,popoverClass:h}){if(this.placement=e,this.useTransition=t,this.offset=n,this.hideDelay=o,this.popoverClass=h,this.$triggerEle=a,r){const t=document.createElement("div");t.classList.add("tooltip-text"),t.innerHTML=r,this.$content=t}else mt[s]=mt[s]||U(i.$qs(s)),this.$content=mt[s];this.$edgeEle=i,this.$popover=null,this.isShow=!1}async show(){this.isShow||(this.$popover||this.initPopover(),this.$edgeEle.appendChild(this.$popover),this.$popover.appendChild(this.$content),this.setPopoverStyle(),J(this.$popover,!0),await K(),G(this.$popover,!0),this.OutsideUnbind=ht(this.$popover,(()=>{lt.currentModal&&lt.currentModal>this.$popover.style.zIndex||(this.hide(),this.OutsideUnbind())})),this.isShow=!0,this.hideDelay&&setTimeout((()=>{this.hide()}),this.hideDelay))}setPopoverStyle(){const t=this.$edgeEle.getBoundingClientRect(),e=this.$triggerEle.getBoundingClientRect(),{top:n,left:s}=function(t,e,n,s,i,a){let r,o;switch(a){case"top":default:r=e.left+e.width/2-n/2,o=e.top-s-i;break;case"left":r=e.left-n-i,o=e.top+e.height/2-s/2;break;case"right":r=e.left+e.width+i,o=e.top+e.height/2-s/2;break;case"bottom":r=e.left+e.width/2-n/2,o=e.top+e.height+i}r-=t.left,o-=t.top;const h=t.width,c=t.height;return r<0?r=0:r+n>h&&(r=h-n),o<0?o=0:o+s>c&&(o=c-s),{left:r,top:o}}(t,e,this.$popover.offsetWidth,this.$popover.offsetHeight,this.offset,this.placement);this.$popover.style.top=`${n}px`,this.$popover.style.left=`${s}px`,this.$popover.style.bottom="initial",lt.global+=1,this.$popover.style.zIndex=lt.global}initPopover(){const t=document.createElement("div");t.classList.add("chat_popover"),this.popoverClass&&t.classList.add(this.popoverClass),[t.style.transformOrigin,t.style.transform]={top:["bottom","scaleY(0.01)"],bottom:["top","scaleY(0.01)"],left:["right","scaleX(0.01)"],right:["left","scaleX(0.01)"]}[this.placement],this.useTransition&&(t.style.transition="all .2s,opacity .15s"),this.$popover=t}async hide(){if(!this.isShow)return;const t=()=>{J(this.$popover,!1),U(this.$content),U(this.$popover),this.OutsideUnbind(),this.$popover.removeEventListener("transitionend",t)};this.$popover.addEventListener("transitionend",t),G(this.$popover,!1),this.isShow=!1}}class wt extends E{constructor(t){super(),this.chatView=t,this.$content=t.$chatView.$qs(".content_command"),this.$showBtn=t.$chatView.$qs(".operate_btn_command"),this.popover=new gt({placement:"top",contentSelector:".content_command",$edgeEle:t.$chatView,$triggerEle:this.$showBtn,offset:6}),this.bindShowClick(),this.bindClickCommand(),this.checkAutoSave()}checkAutoSave(){this.chatView.options.autoSave&&(this.$content.$qs("[command=history]").style.display="none")}bindShowClick(){this.$showBtn.addEventListener("click",(()=>{this.popover.show()}))}bindClickCommand(){this.$content.addEventListener("click",(t=>{const e=Y("[command]",t.target);if(!e)return;const n=e.getAttribute("command");this.excuteCommand(n)}))}async excuteCommand(t){try{await this.chatView.chatData.handleCommand(t,this.chatView.chatEngine),this.handleCommandSuccess(t)}catch(t){console.error(t),this.handleCommandFail(JSON.parse(t.message))}}get$commandByType(t){return this.$content.$qs(`[command=${t}]`)}showTooltip(t,e){new gt({placement:"right",text:t,$edgeEle:this.chatView.$chatView,$triggerEle:e,offset:0,hideDelay:1e3}).show()}handleCommandSuccess(t){const e=this.get$commandByType(t);this.showTooltip("success",e)}handleCommandFail({type:t,reason:e}){const n=this.get$commandByType(t);this.showTooltip(e,n)}}class ft extends E{constructor({$content:t,$chatView:e,title:n,saveText:s="Save",cancelText:i="Cancel"}){super(),this.$wrapper=document.createElement("div"),this.$wrapper.innerHTML=`<div class="form_wrapper">\n        <div class="form_wrapper_top flex-center-between">\n            <div class="wapper_title">${n}</div>\n            <div class="wapper_close bx bx-x icon-action"></div>\n        </div>\n        <div class="wrapper_content"></div>\n        <div class="wrapper_op">\n            <button class="chat_button wrapper_btn_cancel">${i}</button>\n            <button class="chat_button wrapper_btn_save ml-1">${s}</button>\n        </div>\n    </div>`,this.$content=t,this.$chatView=e,this.$save=this.$wrapper.$qs(".wrapper_btn_save"),this.$wrapper.$qs(".wrapper_content").appendChild(t),e.appendChild(this.$wrapper),console.log(this.$wrapper),this.modal=new pt({type:"dialog",$content:this.$wrapper,$chatView:e}),this.flagObj=null,this.bindEvents()}bindEvents(){this.$wrapper.$qs(".wapper_close").addEventListener("click",(t=>{this.emit(o)})),this.$save.addEventListener("click",(t=>{console.dir(this.$content);const e=Array.from(this.$content.querySelectorAll("[name]")).reduce(((t,e)=>(t[e.name]=e.value,e.value||this.showTooltip("no empty"),t)),{});this.emit(r,e,this.flagObj)})),this.$wrapper.$qs(".wrapper_btn_cancel").addEventListener("click",(t=>{this.emit(o)}))}showTooltip(t){new gt({placement:"top",text:t,$edgeEle:this.$chatView,$triggerEle:this.$save,offset:8,hideDelay:1e3}).show()}show(t,{title:e,formData:n={},flagObj:s}={}){e&&(this.$wrapper.$qs(".wapper_title").textContent=e),Array.from(this.$content.querySelectorAll("[name]")).forEach((t=>{t.value=n[t.name]||""})),this.flagObj=s,this.modal.show(t)}hide(){this.enable(!0),this.modal.hide()}enable(t){this.$wrapper.$qs(".wrapper_btn_save").disabled=!t,this.$wrapper.$qs(".wrapper_btn_cancel").disabled=!t}}class vt extends E{constructor(t){super(),this.chatView=t,this.$promptContent=t.$chatView.$qs(".prompt_content"),this.$content=t.$chatView.$qs(".content_select_prompt"),this.$showBtn=t.$chatView.$qs(".operate_btn_prompt"),this.Popover=new gt({placement:"top",contentSelector:".content_select_prompt",$edgeEle:t.$chatView,$triggerEle:this.$showBtn,offset:5,popoverClass:"popover_prompt"}),this.$num=this.$content.$qs(".select_num"),this.$addBtn=this.$content.$qs(".select_add"),this.$closeBtn=this.$content.$qs(".select_close"),this.$search=this.$content.$qs(".select_search_input"),this.$list=this.$content.$qs(".select_list"),this.$promptTpl=U(this.$content.$qs(".select_item")),this.$contentForm=t.$chatView.$qs(".content_prompt_form"),this.ModalForm=new ft({$content:this.$contentForm,$chatView:t.$chatView,title:"Add temlate"}),this.prompts=[],this.bindEvents()}hide(){this.Popover.hide()}bindEvents(){this.$showBtn.addEventListener("click",(async t=>{this.Popover.show(t),this.loadPrompts()})),this.bindContentEvents(),this.bindListEvents(),this.bindFormEvents()}bindContentEvents(){this.$promptContent.$qs(".prompt_content_close").addEventListener("click",(()=>{this.$promptContent.style.height="0px",J(this.$promptContent,!1),this.clearContent(),this.emit(h,!1)}))}clearContent(){this.promptContent="",this.$text.innerHTML=""}bindListEvents(){this.$addBtn.addEventListener("click",(async t=>{this.ModalForm.show(t,{title:"Add temlate"})})),this.$closeBtn.addEventListener("click",(()=>{this.hide()})),this.$search.addEventListener("input",(t=>{this.renderSearch(t.target.value)})),this.$list.addEventListener("click",(async t=>{const e=Y("[data-id]",t.target);if(e){const n=this.prompts.find((t=>t.id===e.dataset.id));let s="select";if(t.target.classList.contains("bx-edit-alt")?s="edit":t.target.classList.contains("bx-trash")&&(s="delete"),"edit"===s)return void this.ModalForm.show(t,{title:"Edit temlate",formData:{"prompt-name":n.name,"prompt-content":n.content},flagObj:n});if("delete"===s)return await this.chatView.chatData.deletePrompt(n),void this.loadPrompts();console.log(n),this.handlePromptContent(n),this.Popover.hide()}}))}async handlePromptContent(t){this.promptContent=t.content,J(this.$promptContent,!0),this.renderContent(t)}async renderContent(t){this.$text=this.$promptContent.$qs(".prompt_content_text"),this.$text.innerHTML=(t=>{let e,n=t;for(;null!==(e=X.exec(n));){const t=e[0],s=`<select name="${e[1].trim()}">${e[2].split("|").map((t=>t.trim())).map((t=>`<option value="${t}">${t}</option>`)).join("")}<select>`;n=n.replace(t,s)}return X.lastIndex=0,n})(t.content),await K(),this.$promptContent.style.height=`${this.$text.offsetHeight+40}px`,this.emit(h,!0)}bindFormEvents(){this.ModalForm.on(r,(async(t,e)=>{if(console.log(e),this.ModalForm.enable(!1),e){const n={...e,name:t["prompt-name"],content:t["prompt-content"]};await this.chatView.chatData.updatePrompt(n)}else{const e={name:t["prompt-name"],content:t["prompt-content"],id:Date.now().toString()};await this.chatView.chatData.createPrompt(e)}this.ModalForm.hide(),this.loadPrompts()})),this.ModalForm.on(o,(()=>{this.ModalForm.hide()}))}async loadPrompts(){this.prompts=(await this.chatView.chatData.getPrompts()||[]).sort(((t,e)=>e.order-t.order)),this.renderCount(this.prompts.length),this.renderList(this.prompts)}renderCount(t){this.$num.textContent=t}renderList(t){this.$list.innerHTML="";const e=document.createDocumentFragment();t.forEach((t=>{const n=this.$promptTpl.cloneNode(!0);n.setAttribute("data-id",t.id),n.$qs(".item_title").textContent=t.name;const s=n.$qs(".item_preview");s.setAttribute("title",t.content),s.textContent=t.content,e.appendChild(n)})),this.$list.appendChild(e)}renderSearch(t){const e=this.prompts.filter((e=>e.name.includes(t)||e.content.includes(t)));this.renderList(e)}$getParsedPromt(){return this.promptContent?((t,e)=>{let n=this.promptContent;return Array.from(t.querySelectorAll("select")).forEach((t=>{const e=X.exec(n)[0];n=n.replace(e,t.value)})),X.lastIndex=0,n})(this.$promptContent):""}}class $t extends E{constructor({options:t,chatData:e,chatEngine:n}){super(),this.options=t,this.chatData=e,this.chatEngine=n,this.appendEleToHost(),this.$chatView=null,this.initSkeleton(),this.activateElements(),this.initViewWidth(),this.bindListeners()}appendEleToHost(){this.appendToggleBtn()}appendToggleBtn(){z()}initSkeleton(){z()}activateElements(){this.eleThread=new Q(this),this.eleResizer=new tt(this),this.eleGenerate=new et(this),this.elePrompt=new vt(this),this.eleInput=new nt(this),this.eleStatus=new it(this),this.eleFace=new at(this),this.eleCollapse=new rt(this),this.eleHistory=new dt(this),this.eleNewChat=new ut(this),this.eleCommand=new wt(this)}initViewWidth(){this.$chatView.style.width=`${this.options[v]}px`}bindListeners(){this.bindShortcut()}bindShortcut(){z()}showView(){this.emit(i),this.$chatView.classList.add(f)}hideView(){this.emit(a),this.$chatView.classList.remove(f)}isViewShow(){return this.$chatView.classList.contains(f)}toggleView(){this.isViewShow()?this.hideView():this.showView()}}class bt extends $t{initSkeleton(){this.$chatView=document.$qs(".chat-wrapper")}appendEleToHost(){this.appendToggleBtn(),this.appendCreateMsgBtn()}appendToggleBtn(){const t=document.$qs(".operation"),e=document.createElement("button");e.textContent="toggle",e.addEventListener("click",(()=>{this.toggleView()})),t.appendChild(e),setTimeout((()=>{this.toggleView()}),0)}appendCreateMsgBtn(){const n=document.$qs(".operation"),s=document.createElement("button");s.textContent="createMsg",s.addEventListener("click",(()=>{[{role:t,content:"this is a test message"},{role:e,content:"true"},{role:t,content:"can you tell me a story?"},{role:e,content:"Sure, I'd love to tell you a story. Here's one I know:\n\n                Once upon a time, in a far-off land, there was a poor farmer named Jack. Jack had a small piece of land and a few animals, but he struggled to make ends meet. One day, while plowing his field, Jack found a shiny golden egg. He couldn't believe his luck!\n                \n                Jack took the egg to the market and sold it for a good price. The next day, he found another golden egg. And the day after that, and the day after that. Every day, Jack found a new golden egg, and he became very rich.\n                \n                But Jack grew greedy. He thought to himself, \"If I could get all the eggs at once, I'd be the richest man in the world!\" So he killed the goose that laid the golden eggs, hoping to find all the eggs inside.\n                \n                But when he opened the goose, there were no eggs. Jack had killed the goose that had given him so much wealth and happiness.\n                \n                The moral of the story is: greed can lead to loss. It's important to be grateful for what we have and not to take it for granted."}].forEach((t=>{this.eleThread.appendElByMessage(t)}))})),n.appendChild(s)}bindShortcut(){window.addEventListener("keydown",(t=>{t.altKey&&"q"===t.key?this.toggleView():"Escape"===t.key&&(console.log(t),this.isViewShow()&&(t.preventDefault(),t.stopPropagation(),this.hideView()))}),!0)}}var yt=n(447),xt={};xt.styleTagTransform=N(),xt.setAttributes=B(),xt.insert=O().bind(null,"head"),xt.domAPI=V(),xt.insertStyleElement=D(),M()(yt.Z,xt),yt.Z&&yt.Z.locals&&yt.Z.locals;class _t extends E{async initOptions(){const t=await this.getOptions();if(!t)return this.setDefaultOptions();if(!function(t,e){let n=!1;return Object.keys(t).forEach((t=>{t in e||(n=!0)})),n}(x,t))return t;const e=function(t,e){const n={...e};return Object.keys(t).forEach((s=>{s in e&&(n[s]=t[s])})),n}(t,x);return this.setOptions(e)}async initPrompts(){if(!await this.getPrompts())return this.setDefaultPrompts()}async getOptions(){z()}async setOption(t,e){this.emit(m,{status:"optionSyncing",key:t,value:e});const n=await this.getOptions();n[t]=e,await this.setOptions(n),this.emit(m,{status:g,key:t,value:e})}async setOptions(){z()}async setDefaultOptions(){z()}async getOption(t){return(await this.getOptions())[t]}async getPrompts(){z()}async setPrompts(){z()}async setDefaultPrompts(){z()}async createPrompt(t){const e=await this.getPrompts(),n={...t,order:e.length};e.push(n),await this.setPrompts(e)}async updatePrompt(t,e){const n=await this.getPrompts(),s=n.findIndex((e=>e.id===t.id));if(-1===s)throw new Error("can't find target prompt");e?n.splice(s,1):n.splice(s,1,t),await this.setPrompts(n)}async deletePrompt(t){await this.updatePrompt(t,!0)}getAcitveNoteContent(){z()}async handleCommand(t,e){console.log(t,e);const n={copy:this.handleCopy.bind(this),favor:this.handleFavor.bind(this),unfavor:this.handleUnfavor.bind(this),save:this.handleSaveNote.bind(this),append:this.handleAppend.bind(this),child:this.handleSaveChild.bind(this),history:this.handleSaveHistory.bind(this)};n[t]&&await n[t](e)}threadToText(t,e,n){let s=t.thread.map((t=>`<p>role: ${t.role}</p><p>${t.content}</p>`)).join("");return n&&(s=t.thread.map((t=>`role: ${t.role}\n${t.content}`)).join("\n")),s||j(e,"no content"),s}handleCopy(t){var e;e=this.threadToText(t,"copy",!0),navigator.clipboard.writeText(e)}async handleFavor(t){await this.toggleFavor(t,!0)}async handleUnfavor(t){await this.toggleFavor(t,!1)}async toggleFavor(t,e){const n=await this.getRecord(t.threadId);n||j(e?"favor":"unfavor","no thread"),n.favor=e,await this.saveRecord(n)}handleSaveNote(){z()}handleAppend(){z()}handleSaveChild(){z()}async handleSaveHistory(t){await this.saveRecordFromEngine(t)}async getRecords(){z()}async saveRecord(){z()}async handleMsgStatus(t,n){if(!n.thread.length)return;const s=[w.success,w.cancel].includes(t),i=n.lastMessage.role===e;s&&i&&this.saveRecordFromEngine(n)}async saveRecordFromEngine(t){const e=t.thread[0];e||j("history","no content");const n={id:t.threadId,originTitle:e.content,list:t.thread.map((t=>{const e={...t};return delete e.status,e}))};await this.saveRecord(n)}}async function Et(t){await Z(200);const e=localStorage.getItem(t);return JSON.parse(e)}async function St(t,e){return await Z(200),localStorage.setItem(t,JSON.stringify(e)),{...e}}class Ct extends _t{async getOptions(){return Et($)}async setOptions(t){return St($,t)}async setDefaultOptions(){return St($,x)}getPrompts(){return Et(b)}async setPrompts(t){return St(b,t)}async setDefaultPrompts(){return St(b,_)}async getAcitveNoteContent(){throw await K(),this.emit(m,{status:"faild",key:"noteId",value:"file"}),new Error("not supported")}async getRecords(){return await Et(y)||[]}async getRecord(t){return(await this.getRecords()).find((e=>e.id===t))}async saveRecord(t){const e=await this.getRecords(),n=e.findIndex((e=>e.id===t.id));return-1!==n?e.splice(n,1,t):e.push(t),St(y,e)}emitTriliumOnly(t){j(t,"TRILIUM_ONLY")}handleSaveNote(){this.emitTriliumOnly("save")}handleAppend(){this.emitTriliumOnly("append")}handleSaveChild(){this.emitTriliumOnly("child")}}class kt{constructor(){this.init()}async init(){const t=this.setChatData(),e=await t.initOptions();await t.initPrompts();const n=this.getEngine(e);this.setView({chatData:t,options:e,chatEngine:n}),n.newChat()}setChatData(){return this.chatData=new Ct,this.chatData.on(m,(t=>{this.chatView.eleStatus.handleDataStatus(t)})),this.chatData}getEngine(t){let e;return"chatGpt"===t.engine&&(e=new k(t)),e.on(d,(n=>{t.autoSave&&this.chatData.handleMsgStatus(n,e)})),e}async setView(t){const e=bt;this.chatView=new e(t)}}Element.prototype.$qs=Element.prototype.querySelector,Document.prototype.$qs=Document.prototype.querySelector,window.requestIdleCallback((()=>{window._triliumChat=new kt}))})()})();